#!/bin/bash
cd /tmp/rom # Depends on where source got synced
rm -rf .repo & # lets remove unnecessary things, so that no storage issue can occur

# Clear RAM
sudo sh -c "sync"
sudo sh -c "echo 3 > /proc/sys/vm/drop_caches"

# Normal build steps
. build/envsetup.sh
lunch lineage_tissot-user
#export SELINUX_IGNORE_NEVERALLOWS=true
export BUILD_TYPE="${BUILD_TYPE}"
export CCACHE_DIR=/tmp/ccache
export CCACHE_EXEC=$(which ccache)
export USE_CCACHE=1
ccache -M 30G
#ccache -o compression=true
#ccache -z

up(){
#    curl --upload-file $1 https://transfer.sh/
    curl --upload-file $1 https://oshi.at/$(basename $1); echo # 14 days, 10 GB limit
}

make_metalava(){
	mka api-stubs-docs -j$(nproc --all)
	mka system-api-stubs-docs -j$(nproc --all)
	mka test-api-stubs-docs -j$(nproc --all)
}

make_rom(){
	mka bacon -j$(nproc --all)
	zip=$(up out/target/product/tissot/*zip)
	echo " "
	echo "$zip"
}

#make_metalava
make_rom
